<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Простой Мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 900px; height: 90vh; background-color: white; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .header { background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .auth-container, .chat-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .auth-form { padding: 40px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .auth-form h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border 0.3s; }
        .input-group input:focus { border-color: #6a11cb; outline: none; }
        .btn { background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, opacity 0.2s; width: 100%; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-small { padding: 8px 15px; width: auto; font-size: 14px; }
        .auth-toggle { text-align: center; margin-top: 20px; color: #666; }
        .auth-toggle a { color: #6a11cb; cursor: pointer; font-weight: 500; text-decoration: none; }
        .sidebar { width: 300px; background-color: #f8f9fa; border-right: 1px solid #eee; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; }
        .sidebar-header h3 { color: #333; font-size: 18px; }
        .users-list { flex: 1; overflow-y: auto; padding: 15px; }
        .user-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: background-color 0.2s; }
        .user-item:hover { background-color: #e9ecef; }
        .user-item.active { background-color: #e3f2fd; border-left: 4px solid #2575fc; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; }
        .user-details h4 { font-size: 16px; color: #333; }
        .user-details p { font-size: 13px; color: #666; margin-top: 3px; }
        .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .chat-header h3 { color: #333; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 18px; position: relative; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: white; border-bottom-right-radius: 5px; }
        .message.received { align-self: flex-start; background-color: #f1f3f4; color: #333; border-bottom-left-radius: 5px; }
        .message-sender { font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .message-time { font-size: 11px; text-align: right; margin-top: 5px; opacity: 0.8; }
        .message-input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .message-input { flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 30px; font-size: 16px; outline: none; transition: border 0.3s; }
        .message-input:focus { border-color: #6a11cb; }
        .send-btn { background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: transform 0.2s; }
        .send-btn:hover { transform: scale(1.05); }
        .status { padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 500; }
        .status.error { background-color: #ffebee; color: #c62828; }
        .status.success { background-color: #e8f5e9; color: #2e7d32; }
        .status.info { background-color: #e3f2fd; color: #1565c0; }
        .status.warning { background-color: #fff3e0; color: #ef6c00; }
        .hidden { display: none !important; }
        .online-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #4caf50; margin-left: auto; }
        @media (max-width: 768px) { .container { height: 95vh; border-radius: 10px; } .sidebar, .chat-area { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"><i class="fas fa-comments"></i><span>Простой Мессенджер</span></div>
            <div class="user-info" id="userInfo"><span id="userName"></span><button class="btn btn-small" id="logoutBtn">Выйти</button></div>
        </div>
        <div class="main-content">
            <div class="auth-container" id="authContainer">
                <div class="auth-form">
                    <h2 id="authTitle">Вход в мессенджер</h2>
                    <div id="authStatus" class="status hidden"></div>
                    <form id="loginForm">
                        <div class="input-group"><label for="username">Имя пользователя</label><input type="text" id="username" placeholder="Введите ваше имя" required></div>
                        <div class="input-group"><label for="password">Пароль</label><input type="password" id="password" placeholder="Введите пароль" required></div>
                        <button type="submit" class="btn" id="loginBtn">Войти</button>
                    </form>
                    <form id="registerForm" class="hidden">
                        <div class="input-group"><label for="regUsername">Имя пользователя</label><input type="text" id="regUsername" placeholder="Придумайте имя" required><small style="color: #666; font-size: 13px; margin-top: 5px; display: block;">Имя будет видно другим пользователям</small></div>
                        <div class="input-group"><label for="regPassword">Пароль</label><input type="password" id="regPassword" placeholder="Придумайте пароль (минимум 6 символов)" required></div>
                        <div class="input-group"><label for="confirmPassword">Подтвердите пароль</label><input type="password" id="confirmPassword" placeholder="Повторите пароль" required></div>
                        <button type="submit" class="btn" id="registerBtn">Зарегистрироваться</button>
                    </form>
                    <div class="auth-toggle"><span id="toggleText">Нет аккаунта?</span><a id="toggleAuth">Зарегистрироваться</a></div>
                </div>
            </div>
            <div class="chat-container hidden" id="chatContainer">
                <div class="sidebar">
                    <div class="sidebar-header"><h3>Пользователи онлайн</h3></div>
                    <div class="users-list" id="usersList"></div>
                </div>
                <div class="chat-area">
                    <div class="chat-header"><div class="user-avatar" id="activeUserAvatar">?</div><div><h3 id="activeUserName">Выберите пользователя</h3><p id="activeUserStatus">Нажмите на пользователя для начала общения</p></div></div>
                    <div class="messages-container" id="messagesContainer"><div class="message" style="align-self: center; max-width: 100%; background-color: #f5f5f5; text-align: center;">Выберите пользователя из списка слева для начала общения</div></div>
                    <div class="message-input-area"><input type="text" class="message-input" id="messageInput" placeholder="Введите сообщение..." disabled><button class="send-btn" id="sendBtn" disabled><i class="fas fa-paper-plane"></i></button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ВАЖНО: ВСТАВЬТЕ СВОЮ КОНФИГУРАЦИЮ FIREBASE ЗДЕСЬ!
         apiKey: "AIzaSyD9MIiOsdps10zDZhaNjnkPj--QXX0o8yc",
  authDomain: "messenger-f7cbd.firebaseapp.com",
  databaseURL: "https://messenger-f7cbd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "messenger-f7cbd",
  storageBucket: "messenger-f7cbd.firebasestorage.app",
  messagingSenderId: "584298804782",
  appId: "1:584298804782:web:c2fc0a168311aca5ed11bf",
  measurementId: "G-9WT3KHJ4GM"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM элементы
        const authContainer = document.getElementById('authContainer');
        const chatContainer = document.getElementById('chatContainer');
        const authTitle = document.getElementById('authTitle');
        const authStatus = document.getElementById('authStatus');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleAuth = document.getElementById('toggleAuth');
        const toggleText = document.getElementById('toggleText');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const usersList = document.getElementById('usersList');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const activeUserName = document.getElementById('activeUserName');
        const activeUserStatus = document.getElementById('activeUserStatus');
        const activeUserAvatar = document.getElementById('activeUserAvatar');

        // Текущий пользователь и выбранный чат
        let currentUser = null;
        let selectedUserId = null;
        let selectedUserName = null;
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        // Переключение между формами входа и регистрации
        toggleAuth.addEventListener('click', () => {
            const isLoginVisible = !loginForm.classList.contains('hidden');
            if (isLoginVisible) {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'Регистрация';
                toggleText.textContent = 'Уже есть аккаунт?';
                toggleAuth.textContent = 'Войти';
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authTitle.textContent = 'Вход в мессенджер';
                toggleText.textContent = 'Нет аккаунта?';
                toggleAuth.textContent = 'Зарегистрироваться';
            }
            authStatus.classList.add('hidden');
        });

        // Обработка входа
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username) { showStatus('Введите имя пользователя', 'error'); return; }
            showStatus('Идет вход...', 'info');
            const email = `${username.toLowerCase().replace(/\s+/g, '')}@messenger.local`;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showStatus('Успешный вход!', 'success');
                    loadChatInterface();
                })
                .catch((error) => {
                    if (error.code === 'auth/user-not-found') {
                        showStatus('Пользователь не найден. Зарегистрируйтесь.', 'warning');
                        toggleAuth.click();
                    } else {
                        showStatus(`Ошибка входа: ${error.message}`, 'error');
                    }
                });
        });

        // Обработка регистрации
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!username) { showStatus('Введите имя пользователя', 'error'); return; }
            if (username.length < 3) { showStatus('Имя пользователя должно быть не менее 3 символов', 'error'); return; }
            if (password.length < 6) { showStatus('Пароль должен быть не менее 6 символов', 'error'); return; }
            if (password !== confirmPassword) { showStatus('Пароли не совпадают', 'error'); return; }
            showStatus('Регистрация...', 'info');
            const email = `${username.toLowerCase().replace(/\s+/g, '')}@messenger.local`;
            checkUsernameExists(username).then(exists => {
                if (exists) { showStatus('Пользователь с таким именем уже существует', 'error'); return; }
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        return db.collection('users').doc(userCredential.user.uid).set({
                            username: username,
                            email: email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                            isOnline: true
                        });
                    })
                    .then(() => {
                        showStatus('Аккаунт успешно создан!', 'success');
                        loadChatInterface();
                    })
                    .catch((error) => {
                        if (error.code === 'auth/email-already-in-use') {
                            showStatus('Пользователь с таким именем уже существует', 'error');
                        } else {
                            showStatus(`Ошибка регистрации: ${error.message}`, 'error');
                        }
                    });
            });
        });

        // Проверка существования имени пользователя
        function checkUsernameExists(username) {
            return db.collection('users')
                .where('username', '==', username)
                .get()
                .then(querySnapshot => {
                    return !querySnapshot.empty;
                });
        }

        // Выход из аккаунта
        logoutBtn.addEventListener('click', () => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            auth.signOut().then(() => {
                showAuthInterface();
                showStatus('Вы вышли из аккаунта', 'success');
            });
        });

        // Отправка сообщения
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Функция отправки сообщения
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !selectedUserId || !currentUser) return;
            const message = {
                senderId: currentUser.uid,
                senderName: currentUser.displayName || currentUser.username,
                receiverId: selectedUserId,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            };
            db.collection('messages').add(message)
                .then(() => {
                    messageInput.value = '';
                    messageInput.focus();
                })
                .catch((error) => {
                    console.error('Ошибка отправки сообщения:', error);
                    showStatus('Не удалось отправить сообщение', 'error');
                });
        }

        // Показать интерфейс аутентификации
        function showAuthInterface() {
            authContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            currentUser = null;
            selectedUserId = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeUsers) unsubscribeUsers();
            loginForm.reset();
            registerForm.reset();
        }

        // Загрузить интерфейс чата после входа
        function loadChatInterface() {
            currentUser = auth.currentUser;
            if (!currentUser) { showAuthInterface(); return; }
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUser.username = userData.username;
                        currentUser.displayName = userData.username;
                        db.collection('users').doc(currentUser.uid).update({
                            isOnline: true,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        userName.textContent = currentUser.username;
                        authContainer.classList.add('hidden');
                        chatContainer.classList.remove('hidden');
                        loadUsers();
                    } else {
                        showStatus('Ошибка загрузки данных пользователя', 'error');
                        auth.signOut();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных пользователя:', error);
                    showAuthInterface();
                });
        }

        // Загрузить список пользователей
        function loadUsers() {
            usersList.innerHTML = '<div class="status info">Загрузка пользователей...</div>';
            unsubscribeUsers = db.collection('users')
                .where('username', '!=', currentUser.username)
                .onSnapshot((querySnapshot) => {
                    usersList.innerHTML = '';
                    let users = [];
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        user.id = doc.id;
                        users.push(user);
                    });
                    users.sort((a, b) => {
                        if (a.isOnline && !b.isOnline) return -1;
                        if (!a.isOnline && b.isOnline) return 1;
                        return a.username.localeCompare(b.username);
                    });
                    if (users.length === 0) {
                        usersList.innerHTML = '<div class="status info">Других пользователей не найдено</div>';
                        return;
                    }
                    users.forEach((user) => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        userElement.dataset.userId = user.id;
                        userElement.dataset.userName = user.username;
                        const avatarLetter = user.username ? user.username.charAt(0).toUpperCase() : '?';
                        userElement.innerHTML = `
                            <div class="user-avatar">${avatarLetter}</div>
                            <div class="user-details">
                                <h4>${user.username}</h4>
                                <p>${user.isOnline ? 'В сети' : 'Не в сети'}</p>
                            </div>
                            ${user.isOnline ? '<div class="online-dot"></div>' : ''}
                        `;
                        userElement.addEventListener('click', () => selectUser(user.id, user.username, avatarLetter));
                        usersList.appendChild(userElement);
                    });
                }, (error) => {
                    console.error('Ошибка загрузки пользователей:', error);
                    usersList.innerHTML = '<div class="status error">Не удалось загрузить пользователей</div>';
                });
        }

        // Выбрать пользователя для чата
        function selectUser(userId, username, avatarLetter) {
            selectedUserId = userId;
            selectedUserName = username;
            activeUserName.textContent = username;
            activeUserStatus.textContent = 'В сети';
            activeUserAvatar.textContent = avatarLetter;
            document.querySelectorAll('.user-item').forEach(item => {
                if (item.dataset.userId === userId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = `Сообщение для ${username}...`;
            messageInput.focus();
            loadMessages(userId);
        }

        // Загрузить сообщения с выбранным пользователем
        function loadMessages(userId) {
            messagesContainer.innerHTML = '<div class="status info">Загрузка сообщений...</div>';
            if (unsubscribeMessages) { unsubscribeMessages(); }
            unsubscribeMessages = db.collection('messages')
                .where('senderId', 'in', [currentUser.uid, userId])
                .where('receiverId', 'in', [currentUser.uid, userId])
                .orderBy('timestamp')
                .onSnapshot((querySnapshot) => {
                    messagesContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        messagesContainer.innerHTML = '<div class="message" style="align-self: center; max-width: 100%; background-color: #f5f5f5; text-align: center;">Нет сообщений. Начните общение!</div>';
                    }
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        displayMessage(message);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, (error) => {
                    console.error('Ошибка загрузки сообщений:', error);
                    messagesContainer.innerHTML = '<div class="status error">Не удалось загрузить сообщения</div>';
                });
        }

        // Отобразить сообщение
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            const time = message.timestamp ? 
                new Date(message.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageElement.innerHTML = `
                <div class="message-sender">${message.senderId === currentUser.uid ? 'Вы' : message.senderName}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${time}</div>
            `;
            messagesContainer.appendChild(messageElement);
        }

        // Показать статус
        function showStatus(message, type) {
            authStatus.textContent = message;
            authStatus.className = `status ${type}`;
            authStatus.classList.remove('hidden');
            if (type !== 'info') {
                setTimeout(() => {
                    authStatus.classList.add('hidden');
                }, 5000);
            }
        }

        // Обновление статуса "последний раз в сети" при выходе
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // Проверка состояния аутентификации при загрузке
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadChatInterface();
            } else {
                showAuthInterface();
            }
        });

        // Инициализация при загрузке страницы
        window.addEventListener('DOMContentLoaded', () => {
            showStatus('Подключение к мессенджеру...', 'info');
        });
    </script>
</body>
</html>
